# Piper general purpose pipeline
# This pipeline was generated by Hyperspace Onboarding
# To modify the pipeline or add additional steps please check:
# https://github.wdf.sap.corp/pages/ContinuousDelivery/piper-doc/stages/
general:
  buildTool: golang
  owner: CoLa
  repository: mcp-operator
  productiveBranch: main
  githubApiUrl: 'https://github.tools.sap/api/v3'
  githubServerUrl: 'https://github.tools.sap'
  vaultBasePath: piper/PIPELINE-GROUP-5266
  vaultNamespace: ies/hyperspace/pipelines
  vaultPath: piper/PIPELINE-GROUP-5266
  vaultPipelineName: PIPELINE-36006
  vaultServerUrl: https://vault.tools.sap
  nativeBuild: true

  whitesourceProductName: 'SHC - openmcp-operator'
  whitesourceProductToken: '1c1a9f6f2df844fd8b651a20c5458b3801ddab2564b44b82ab4fef6aa978ed95'

  privateModules: 'github.tools.sap/*'

stages:
  Build:
    kanikoExecute: true
    helmExecute: true
  Release:
    sapDownloadArtifact: false # not yet supported by piper
    githubPublishRelease: true
  Post:
    # Necessary to generate the release-status-*.json which marks the run as "promoted".
    # https://github.tools.sap/project-piper/piper-pipeline-azure/blob/68862db98faefc00da924d61cbd8fd5d49bdc19d/stages/post.yml#L108
    sapGenerateEnvironmentInfo: true

steps:
  artifactPrepareVersion:
    gitHttpsCredentialVaultSecretName: GROUP-SECRETS/github-cola-serviceuser
    versioningType: 'library'
    includeCommitId: false
    additionalTargetTools:
      - helm
  kanikoExecute:
    buildOptions: ['--skip-unused-stages', '--build-arg', 'BUILDENV=piper','--build-arg', 'BUILD_TIMESTAMP', '--build-arg', 'GIT_COMMIT', '--build-arg', 'TARGETOS=linux', '--build-arg', 'TARGETARCH=amd64', '--build-arg', 'COMPONENT=mcp-operator']
    containerImageName: openmcp/mcp-operator
  sapCallStagingService:
    profile: group-5266-default
    url: https://staging.repositories.cloud.sap/stage/api
  sapCumulusUpload:
    pipelineId: bc6a24c8-7749-44c2-ba1b-53c41e222973
  sapCheckPPMSCompliance:
    ppmsID: '73555000100200020629'
    ppmsChangeRequestUpload: true
  sonarExecuteScan:
    serverUrl: https://sonar.tools.sap
    sonarVaultSecretName: GROUP-SECRETS/sonar
  golangBuild:
    dockerImage: &GOLANG_BUILDER 'golang:1.23.6@sha256:927112936d6b496ed95f55f362cc09da6e3e624ef868814c56d55bd7323e0959'
    dockerOptions: ['-u', '0', '--env', 'GOEXPERIMENT=nocoverageredesign']
    ldflagsTemplate: '-w -s'
    # By default piper only runs `gotestsum ./...` which excludes our api package since it is its own module.
    # Adding it as a testoption ensures api tests are being run. We need fully qualified gomodule name, since
    # api is not the main module
    testOptions:
      - github.tools.sap/CoLa/mcp-operator/api/...
    packages:
      - 'cmd/mcp-operator/main.go'
    output: 'bin/mcp-operator'
  helmExecute:
    chartPath: 'charts/mcp-operator'
    publish: true
  githubPublishRelease:
    addDeltaToLastRelease: true
    addClosedIssues: true
  whitesourceExecuteScan:
    dockerImage: *GOLANG_BUILDER
    dockerEnvVars:
      GOFLAGS: "-mod=mod -buildvcs=false"
  checkmarxExecuteScan:
    projectName: 'openmcp-operator'
    vulnerabilityThresholdEnabled: false
    teamName: '/CxServer/SP/SAP/BUSINESS_TECHNOLOGY_PLATFORM/COMPONENTS/CLOUD_ORCHESTRATION'
    filterPattern: '**/*.go, !**/*_test.go, !**/vendor/**, !**/test/**, !**/hack/**, !api/**, !**/zz_*.go, !**/*.yml, !**/*.yaml'
    preset: 100099 # SAP_Default_Go
